<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FREEPASSMOBILITY 통합 ERP v018</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css');
        
        * { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; text-rendering: optimizeLegibility; }
        body { font-family: 'Pretendard', sans-serif; font-size: 11px; background-color: #f1f3f6; color: #1e293b; letter-spacing: -0.02em; }

        /* 채팅 말풍선 스타일 */
        .chat-bubble { max-width: 85%; padding: 8px 12px; border-radius: 8px; font-weight: 500; line-height: 1.4; position: relative; }
        .bubble-me { background-color: #2563eb; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .bubble-other { background-color: #f1f5f9; color: #1e293b; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid #e2e8f0; }
        
        /* 알림 토스트 */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #1e293b; color: #fff; text-align: center; 
            border-radius: 8px; padding: 16px; position: fixed; z-index: 20000; left: 50%; bottom: 30px; 
            transform: translateX(-50%); font-size: 12px; font-weight: 600; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        /* 버튼 및 역할 선택 */
        .role-btn { transition: all 0.2s; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; }
        .role-btn.active { background-color: #2563eb; border-color: #2563eb; color: white; transform: scale(1.02); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* 상태 배지 및 줄 강조 */
        .pending-badge { background-color: #ef4444; color: white; padding: 2px 6px; border-radius: 4px; font-size: 8px; font-weight: 900; animation: pulse-fast 1.2s infinite; }
        .request-badge { background-color: #f59e0b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 8px; font-weight: 900; }
        .row-pending-alert { background-color: #fffbeb !important; border-left: 4px solid #f59e0b !important; animation: row-pulse 2s infinite; }
        
        /* 문의 리스트 가로줄 강조 */
        .inquiry-row-active { border-left: 4px solid #2563eb !important; background-color: #eff6ff !important; }
        .inquiry-row-pending { border-left: 4px solid #f59e0b !important; background-color: #fffbeb !important; }

        @keyframes row-pulse { 0% { background-color: #fffbeb; } 50% { background-color: #fef3c7; } 100% { background-color: #fffbeb; } }
        @keyframes pulse-fast { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes alert-glow { 0% { color: #94a3b8; } 50% { color: #ef4444; transform: scale(1.1); } 100% { color: #94a3b8; } }
        
        .tab-alert-active { animation: alert-glow 1.5s infinite !important; font-weight: 900 !important; }

        /* Drawer 슬라이드 및 가변 폭 */
        @keyframes drawerAppear { 0% { transform: translateX(100%); } 100% { transform: translateX(0); } }
        .animate-drawer { animation: drawerAppear 0.3s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        #detail-drawer { transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1), transform 0.3s ease-out; }

        thead th { font-weight: 700; color: #475569; background: #f8f9fb; font-size: 10px; border-bottom: 2px solid #e2e8f0; }
        tbody td { font-weight: 500; height: 52px; border-bottom: 1px solid #f1f5f9; }
        
        .tab-btn.active { background-color: #eff6ff; color: #2563eb; }
        .approval-btn { animation: shadow-pulse 2s infinite; }
        @keyframes shadow-pulse { 0% { box-shadow: 0 0 0 0px rgba(16, 185, 129, 0.4); } 100% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } }
    </style>
</head>
<body class="h-screen overflow-hidden select-none">

<div id="toast">알림 메시지</div>

<!-- 보안 접속 게이트 -->
<div id="gate" class="fixed inset-0 bg-[#0f172a] z-[9999] flex items-center justify-center p-6 text-white text-center text-slate-100">
    <div class="w-full max-w-sm space-y-8 animate-drawer">
        <div class="space-y-2 text-center">
            <h1 class="text-3xl font-black tracking-tighter italic text-blue-500 flex items-center justify-center text-nowrap">
                FREEPASSMOBILITY <span class="ml-2 text-[10px] bg-blue-900/50 text-blue-400 px-2 py-0.5 rounded border border-blue-500/30 not-italic tracking-normal uppercase">v018</span>
            </h1>
            <p class="text-slate-400 font-bold text-[10px] tracking-widest uppercase opacity-70">Unified Multi-Role ERP System</p>
        </div>

        <div class="bg-white/5 p-8 border border-white/10 space-y-6 rounded-3xl backdrop-blur-md shadow-2xl">
            <div class="space-y-3 text-left">
                <p class="text-[10px] font-bold text-white/40 uppercase tracking-tighter ml-1">접속 권한 선택</p>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="changeRole('sales')" id="role-sales" class="role-btn active py-3 rounded-2xl font-black text-[11px] flex flex-col items-center gap-1 text-white">
                        <i data-lucide="trending-up" class="w-4 h-4"></i> 영업자
                    </button>
                    <button onclick="changeRole('supplier')" id="role-supplier" class="role-btn py-3 rounded-2xl font-black text-[11px] flex flex-col items-center gap-1 text-white/50">
                        <i data-lucide="truck" class="w-4 h-4"></i> 공급사
                    </button>
                    <button onclick="changeRole('admin')" id="role-admin" class="role-btn py-3 rounded-2xl font-black text-[11px] flex flex-col items-center gap-1 text-white/50">
                        <i data-lucide="shield" class="w-4 h-4"></i> 관리자
                    </button>
                </div>
            </div>

            <div class="space-y-4">
                <div id="id-container" class="hidden text-left">
                    <label class="text-[9px] font-bold text-white/30 ml-1 uppercase">사업자번호 (ID)</label>
                    <input type="text" id="user-id" placeholder="ID 입력" class="w-full p-4 bg-slate-900 border border-slate-700 text-white outline-none focus:border-blue-500 rounded-2xl font-bold mt-1 transition-all">
                </div>
                <div id="sales-id-container" class="text-left">
                    <label class="text-[9px] font-bold text-white/30 ml-1 uppercase">영업자 연락처 (ID)</label>
                    <input type="text" id="user-phone" placeholder="01012345678" class="w-full p-4 bg-slate-900 border border-slate-700 text-white outline-none focus:border-blue-500 rounded-2xl font-bold mt-1 transition-all">
                </div>
                <div class="space-y-1 text-left">
                    <label class="text-[9px] font-bold text-white/30 ml-1 uppercase">보안코드</label>
                    <input type="password" id="user-pw" value="7777" class="w-full p-4 bg-slate-900 border border-slate-700 text-white text-center tracking-[0.5em] outline-none rounded-2xl focus:border-blue-500 font-bold mt-1 transition-all">
                </div>
            </div>

            <button id="login-btn" onclick="login()" class="w-full py-4 bg-blue-600 text-white font-black rounded-2xl shadow-xl hover:bg-blue-500 transition-all">시스템 보안 접속</button>
        </div>
        <p class="text-white/20 text-[9px] font-medium tracking-tight italic text-center">Build Version: 2026.02.10.018</p>
    </div>
</div>

<!-- 메인 애플리케이션 -->
<div id="app" class="hidden h-screen flex flex-col overflow-hidden bg-[#f1f3f6] text-slate-800">
    <header class="h-[50px] bg-white border-b border-slate-200 flex items-center px-4 justify-between z-50 shadow-sm">
        <div class="flex items-center gap-3">
            <span class="font-black text-blue-600 text-[14px] italic tracking-tighter">FREEPASSMOBILITY</span>
            <div id="top-user-info" class="ml-4 flex items-center gap-2 border-l border-slate-200 pl-4 text-nowrap">
                <span id="role-tag" class="text-[9px] font-black text-blue-500 uppercase tracking-tighter"></span>
                <span id="id-tag" class="font-black text-slate-700"></span>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="relative flex items-center">
                <i data-lucide="search" class="absolute left-2.5 text-slate-400 w-3.5 h-3.5"></i>
                <input type="text" id="searchInput" oninput="handleSearch(this.value)" placeholder="통합 검색..." class="pl-8 pr-4 py-1.5 border border-slate-200 rounded text-[11px] focus:border-blue-400 outline-none w-64 bg-slate-50 font-medium">
            </div>
            <button onclick="location.reload()" class="text-slate-400 font-bold hover:text-rose-500 text-[10px] flex items-center gap-1 transition-colors whitespace-nowrap">
                <i data-lucide="log-out" class="w-3 h-3"></i> 로그아웃
            </button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        <!-- 좌측 사이드바 -->
        <nav class="w-[70px] bg-white border-r border-slate-200 flex flex-col items-center py-6 gap-4 z-40 shadow-sm">
            <button onclick="switchTab('inventory')" id="tab-inventory-btn" class="tab-btn w-12 h-12 flex flex-col items-center justify-center rounded-xl transition-all">
                <i data-lucide="layout-grid" class="w-5 h-5"></i>
                <span class="text-[8px] font-black mt-1 text-nowrap">매물</span>
            </button>
            <button onclick="switchTab('chats')" id="tab-chats-btn" class="tab-btn w-12 h-12 flex flex-col items-center justify-center rounded-xl text-slate-400 hover:bg-slate-50 transition-all relative">
                <i data-lucide="message-square" class="w-5 h-5"></i>
                <span id="tab-chat-label" class="text-[8px] font-black mt-1 text-center leading-none text-nowrap">문의 응대</span>
                <div id="new-chat-dot" class="absolute top-2 right-2 w-2 h-2 bg-rose-500 rounded-full border-2 border-white hidden animate-ping"></div>
                <div id="new-chat-dot-solid" class="absolute top-2 right-2 w-2 h-2 bg-rose-500 rounded-full border-2 border-white hidden"></div>
            </button>
            <div class="mt-auto">
                <button id="add-car-btn" onclick="openRegModal()" class="hidden w-12 h-12 flex flex-col items-center justify-center rounded-xl bg-slate-800 text-white hover:bg-slate-700 transition-all text-nowrap">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    <span class="text-[8px] font-black mt-1 text-nowrap">등록</span>
                </button>
            </div>
        </nav>

        <!-- 중앙 컨텐츠 -->
        <section id="content-area" class="flex-1 flex flex-col min-w-0 relative">
            <!-- 1. 매물 리스트 -->
            <div id="inventory-view" class="flex flex-col h-full text-slate-800">
                <div class="h-10 bg-white border-b border-slate-200 flex items-center px-4">
                    <span id="inventory-title" class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">실시간 매물 현황</span>
                    <div class="ml-auto text-[10px] font-bold text-slate-400">Total: <b id="list-count" class="text-slate-800">0</b>건</div>
                </div>
                <div class="flex-1 overflow-auto bg-white">
                    <table class="w-full border-collapse table-fixed min-w-[800px]">
                        <thead class="sticky top-0 z-10 shadow-sm bg-[#f8f9fb]">
                            <tr class="divide-x divide-slate-100 text-[10px] uppercase text-center">
                                <th class="w-20 py-3">상태</th>
                                <th class="w-24">차량번호</th>
                                <th class="w-32">브랜드/모델</th>
                                <th class="text-left px-4">세부 스펙</th>
                                <th class="w-28">주행거리</th>
                                <th class="w-32 bg-blue-50 text-blue-700">36M 대여료/보증금</th>
                                <th class="w-32 bg-blue-50 text-blue-700">48M 대여료/보증금</th>
                            </tr>
                        </thead>
                        <tbody id="main-list-body" class="divide-y divide-slate-50 text-center"></tbody>
                    </table>
                </div>
            </div>

            <!-- 2. 문의 관제실 (가로줄 리스트) -->
            <div id="chats-view" class="hidden flex flex-col h-full bg-white text-slate-800">
                <div class="h-10 bg-white border-b border-slate-200 flex items-center px-4 justify-between">
                    <span id="chat-master-title" class="text-[10px] font-black text-slate-700 uppercase tracking-widest flex items-center gap-2 text-nowrap">
                        <i data-lucide="activity" class="w-3 h-3 text-rose-500"></i> 실시간 문의 관리실 (접수순)
                    </span>
                    <div class="flex gap-2">
                        <span id="pending-total-badge" class="bg-rose-500 text-white text-[8px] font-black px-2 py-0.5 rounded-full hidden text-nowrap">미대응 0</span>
                        <span id="request-total-badge" class="bg-amber-500 text-white text-[8px] font-black px-2 py-0.5 rounded-full hidden text-nowrap">계약요청 0</span>
                    </div>
                </div>
                <div class="flex-1 overflow-auto bg-slate-50">
                    <table class="w-full border-collapse table-fixed min-w-[800px]">
                        <thead class="sticky top-0 z-10 shadow-sm bg-[#f8f9fb]">
                            <tr class="divide-x divide-slate-100 text-[10px] uppercase text-center text-slate-500">
                                <th class="w-20 py-3">처리상태</th>
                                <th class="w-32">영업자 연락처</th>
                                <th class="w-32">대상 차량번호</th>
                                <th class="text-left px-4">최신 문의 내용 (회신대기)</th>
                                <th class="w-24">차종 정보</th>
                                <th class="w-24">수신시간</th>
                            </tr>
                        </thead>
                        <tbody id="master-inquiry-list" class="divide-y divide-slate-100 bg-white text-center"></tbody>
                    </table>
                </div>
            </div>

            <!-- 통합 상세 Drawer (듀얼 뷰) -->
            <div id="detail-drawer" class="absolute right-0 top-0 h-full w-[460px] bg-white shadow-2xl border-l border-slate-200 z-[100] transform translate-x-full transition-all duration-400 flex flex-row overflow-hidden text-slate-800">
                <!-- 좌측 채팅 대응 영역 -->
                <div id="drawer-chat-area" class="w-0 border-r border-slate-100 flex flex-col bg-[#f8fafc] overflow-hidden transition-all duration-400">
                    <div class="h-[50px] border-b bg-slate-50 flex items-center px-4 justify-between text-nowrap">
                        <div class="flex flex-col">
                            <span id="drawer-chat-title" class="font-black text-blue-600 text-[11px] flex items-center gap-2">실시간 문의 대화</span>
                            <span id="drawer-chat-target" class="text-[9px] font-bold text-slate-400">상대: -</span>
                        </div>
                        <button onclick="toggleDrawerChat(false)" class="text-slate-400 hover:text-slate-600 p-1"><i data-lucide="chevrons-right" class="w-4 h-4"></i></button>
                    </div>
                    
                    <div id="drawer-approval-header" class="hidden p-3 bg-white border-b border-blue-50 flex flex-col gap-2">
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] font-black text-slate-600 uppercase tracking-tighter">계약 승인 관리</span>
                            <span id="drawer-approval-status" class="request-badge">계약요청</span>
                        </div>
                        <div id="drawer-approval-action"></div>
                    </div>

                    <div id="drawer-chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col gap-3"></div>
                    
                    <div class="p-3 border-t bg-white flex gap-2 shadow-inner">
                        <input type="text" id="drawer-chat-input" placeholder="메시지 입력..." class="flex-1 p-2.5 border border-slate-200 rounded-xl outline-none focus:border-blue-500 text-[11px] font-medium" onkeypress="if(event.key==='Enter') sendMsgFromDrawer()">
                        <button onclick="sendMsgFromDrawer()" class="bg-blue-600 text-white px-4 py-2 rounded-xl font-black hover:bg-blue-700 transition-all flex items-center justify-center">
                            <i data-lucide="send" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 우측 차량 정보 영역 -->
                <div id="drawer-info-area" class="w-[460px] flex-shrink-0 flex flex-col bg-white"></div>
            </div>
        </section>
    </main>
</div>

<!-- 매물 등록 모달 -->
<div id="reg-modal" class="fixed inset-0 bg-slate-900/60 z-[10000] hidden flex items-center justify-center p-6 backdrop-blur-sm">
    <div class="bg-white w-full max-w-lg p-8 shadow-2xl rounded-3xl text-slate-800">
        <h3 class="font-black text-blue-600 border-b pb-4 mb-6 text-lg flex items-center gap-2 uppercase tracking-tighter">
            <i data-lucide="plus-circle" class="w-5 h-5"></i> 매물 신규 등록
        </h3>
        <div class="grid grid-cols-2 gap-4 max-h-[420px] overflow-y-auto pr-2 hide-scrollbar">
            <div class="col-span-1"><label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase">차량번호</label><input type="text" id="reg-no" class="w-full p-2.5 border rounded-xl font-bold outline-none" placeholder="12가3456"></div>
            <div class="col-span-1"><label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase">제조사</label><input type="text" id="reg-brand" class="w-full p-2.5 border rounded-xl font-bold outline-none" placeholder="현대"></div>
            <div class="col-span-2"><label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase">모델명</label><input type="text" id="reg-model" class="w-full p-2.5 border rounded-xl font-bold outline-none" placeholder="그랜저 GN7"></div>
            <div class="col-span-1"><label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase">주행거리(km)</label><input type="number" id="reg-mileage" class="w-full p-2.5 border rounded-xl font-bold outline-none"></div>
            <div class="col-span-1"><label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase">연료</label><input type="text" id="reg-fuel" class="w-full p-2.5 border rounded-xl font-bold outline-none"></div>
            <div class="col-span-1 border-t pt-4 mt-2"><label class="block text-[10px] font-bold text-blue-600 mb-1 uppercase">36M 대여료</label><input type="text" id="reg-36m" class="w-full p-2.5 border border-blue-100 bg-blue-50/50 rounded-xl font-black outline-none"></div>
            <div class="col-span-1 border-t pt-4 mt-2"><label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase">36M 보증금</label><input type="text" id="reg-36d" class="w-full p-2.5 border rounded-xl font-bold outline-none"></div>
            <div class="col-span-1 border-t pt-4 mt-2"><label class="block text-[10px] font-bold text-blue-600 mb-1 uppercase">48M 대여료</label><input type="text" id="reg-48m" class="w-full p-2.5 border border-blue-100 bg-blue-50/50 rounded-xl font-black outline-none"></div>
            <div class="col-span-1 border-t pt-4 mt-2"><label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase">48M 보증금</label><input type="text" id="reg-48d" class="w-full p-2.5 border rounded-xl font-bold outline-none"></div>
            <div class="col-span-2 border-t pt-4 mt-2"><label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase">세부 스펙</label><textarea id="reg-spec" class="w-full p-2.5 border rounded-xl font-bold outline-none h-20" placeholder="옵션 및 차량 상세 정보를 입력하세요."></textarea></div>
        </div>
        <div class="pt-8 space-y-2 text-center">
            <button id="save-btn" onclick="saveNewCar()" class="w-full py-4 bg-blue-600 text-white font-black rounded-2xl hover:bg-blue-700 shadow-lg transition-all">매물 등록 완료</button>
            <button onclick="closeRegModal()" class="w-full py-3 text-slate-400 font-bold hover:text-slate-600 transition-colors">닫기</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc, addDoc, serverTimestamp, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // 사용자 제공 Firebase 설정
    const firebaseConfig = {
        apiKey: "AIzaSyBlVYdSkA7RDgzfOmIWq8BUSMtDQ_H1E5Q",
        authDomain: "freepasserp.firebaseapp.com",
        projectId: "freepasserp",
        storageBucket: "freepasserp.firebasestorage.app",
        messagingSenderId: "1148826501",
        appId: "1:1148826501:web:d8c6cede613949a2610aec",
        measurementId: "G-HVZ10P3ED9"
    };

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'freepassmobility-v1';
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const BASE_PATH = `/artifacts/${appId}/public/data/cars`;

    let me = { id: '', role: 'sales', phone: '' };
    let rawCars = [];
    let selectedId = null;
    let currentInquiryPhone = '';
    let currentTab = 'inventory';
    let chatUnsubscribe = null;
    let currentSearch = "";

    lucide.createIcons();

    window.showMessage = (msg) => {
        const toast = document.getElementById("toast");
        toast.innerText = msg; toast.className = "show";
        setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
    };

    window.changeRole = (role) => {
        me.role = role;
        ['sales', 'supplier', 'admin'].forEach(r => {
            const btn = document.getElementById(`role-${r}`);
            r === role ? (btn.classList.add('active'), btn.classList.remove('text-white/50')) : (btn.classList.remove('active'), btn.classList.add('text-white/50'));
        });
        document.getElementById('id-container').className = role === 'sales' ? 'hidden' : '';
        document.getElementById('sales-id-container').className = role === 'sales' ? '' : 'hidden';
    };

    window.login = async () => {
        const idInput = document.getElementById('user-id').value.trim();
        const phoneInput = document.getElementById('user-phone').value.trim();
        if ((me.role === 'sales' && !phoneInput) || (me.role !== 'sales' && !idInput)) return showMessage('인증 정보를 입력하세요.');
        if (document.getElementById('user-pw').value !== '7777') return showMessage('보안코드 오류');

        try {
            await signInAnonymously(auth);
            me.id = me.role === 'sales' ? phoneInput : idInput;
            me.phone = me.role === 'sales' ? phoneInput : '';
            
            document.getElementById('gate').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('id-tag').innerText = me.id;
            document.getElementById('role-tag').innerText = me.role.toUpperCase();
            
            if (me.role !== 'sales') document.getElementById('add-car-btn').classList.remove('hidden');
            
            initRealtimeList();
            switchTab(me.role === 'sales' ? 'inventory' : 'chats');
            lucide.createIcons();
        } catch (e) { showMessage('접속 실패'); }
    };

    function initRealtimeList() {
        if (!auth.currentUser) return;
        const carCol = collection(db, ...BASE_PATH.split('/').filter(p => p));
        onSnapshot(carCol, (snap) => {
            rawCars = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderUI();
        });
    }

    function renderUI() {
        renderMainList();
        if (currentTab === 'chats') renderMasterInquiryList();
        
        let pCount = 0; let rCount = 0;
        rawCars.forEach(c => {
            // 알림 필터 로직: 관리자는 전체, 공급사는 본인 차량만
            if (me.role === 'supplier' && c.공급사 !== me.id) return;
            
            if (c.상태 === '계약요청') rCount++;
            if (c.inquiryList) {
                Object.entries(c.inquiryList).forEach(([ph, inq]) => {
                    // 미대응 건수 카운트
                    if (me.role !== 'sales' && inq.status === 'pending') pCount++;
                });
            }
        });
        
        const hasAlert = (me.role !== 'sales' && (pCount > 0 || rCount > 0));
        document.getElementById('new-chat-dot').classList.toggle('hidden', !hasAlert);
        document.getElementById('new-chat-dot-solid').classList.toggle('hidden', !hasAlert);
        document.getElementById('tab-chats-btn').classList.toggle('tab-alert-active', hasAlert);
        
        document.getElementById('pending-total-badge').innerText = `미대응 ${pCount}`;
        document.getElementById('pending-total-badge').classList.toggle('hidden', me.role === 'sales' || pCount === 0);
        document.getElementById('request-total-badge').innerText = `계약요청 ${rCount}`;
        document.getElementById('request-total-badge').classList.toggle('hidden', me.role === 'sales' || rCount === 0);
    }

    function renderMainList() {
        const body = document.getElementById('main-list-body');
        let filtered = (me.role === 'supplier') ? rawCars.filter(c => c.공급사 === me.id) : rawCars;
        filtered = filtered.filter(c => JSON.stringify(c).toLowerCase().includes(currentSearch.toLowerCase()));
        filtered.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
        
        document.getElementById('list-count').innerText = filtered.length;
        body.innerHTML = filtered.map(c => {
            const isSelected = selectedId === c.id;
            const hasPending = c.inquiryList && Object.values(c.inquiryList).some(i => i.status === 'pending');
            return `<tr onclick="selectCar('${c.id}')" class="cursor-pointer hover:bg-slate-50 transition-all divide-x divide-slate-50 ${isSelected ? 'bg-blue-50 ring-1 ring-inset ring-blue-200' : ''} ${me.role!=='sales'&&hasPending?'row-pending-alert':''}">
                <td class="py-3 text-center"><span class="px-1.5 py-0.5 rounded text-[9px] font-black border ${c.상태==='대여가능'?'bg-emerald-50 text-emerald-600 border-emerald-100':'bg-rose-50 text-rose-600 border-rose-100'} text-nowrap">${c.상태 || '대여가능'}</span></td>
                <td class="text-center font-black text-slate-800">${c.id}${me.role!=='sales'&&hasPending?'<div class="text-[7px] text-orange-600 font-black mt-0.5 animate-pulse">문의도착</div>':''}</td>
                <td class="text-center"><div class="text-[9px] text-slate-400 font-bold">${c.제조사 || '-'}</div><div class="font-black text-slate-800 truncate px-1">${c.모델 || '-'}</div></td>
                <td class="px-4 font-bold text-slate-700 truncate text-left">${c.세부사양 || c.모델 || '-'}</td>
                <td class="text-right pr-4 font-bold text-slate-600">${parseInt(c.주행거리 || 0).toLocaleString()}km</td>
                <td class="bg-blue-50/30 text-right pr-4 font-black text-blue-700 leading-none"><div>${c.금액_대여료_36M || '-'}원</div><div class="text-[8px] text-slate-400 mt-1 font-bold">보: ${c.금액_보증금_36M || '-'}</div></td>
                <td class="bg-blue-50/30 text-right pr-4 font-black text-blue-700 leading-none"><div>${c.금액_대여료_48M || '-'}원</div><div class="text-[8px] text-slate-400 mt-1 font-bold">보: ${c.금액_보증금_48M || '-'}</div></td>
            </tr>`;
        }).join('');
    }

    function renderMasterInquiryList() {
        const container = document.getElementById('master-inquiry-list');
        container.innerHTML = '';
        const allInquiries = [];
        rawCars.forEach(car => {
            // [중요 로직] 관리자는 모든 차량의 문의를, 공급사는 본인의 차량 문의만 수집
            if (me.role === 'supplier' && car.공급사 !== me.id) return;
            
            if (car.inquiryList) {
                Object.entries(car.inquiryList).forEach(([phone, info]) => {
                    // 영업자는 자신의 문의만
                    if (me.role === 'sales' && phone !== me.phone) return;
                    allInquiries.push({ carId: car.id, carModel: car.모델, carStatus: car.상태, phone, ...info });
                });
            }
        });
        
        allInquiries.sort((a, b) => (a.status === 'pending' ? -1 : 1) || (b.timestamp || 0) - (a.timestamp || 0));
        
        if (allInquiries.length === 0) {
            container.innerHTML = `<tr><td colspan="6" class="p-20 text-center text-slate-400 font-bold italic">진행 중인 문의가 없습니다.</td></tr>`;
            return;
        }
        
        container.innerHTML = allInquiries.map(inq => {
            const isPending = inq.status === 'pending';
            const isSelected = (selectedId === inq.carId && currentInquiryPhone === inq.phone);
            const rowClass = isSelected ? 'inquiry-row-active' : (isPending ? 'inquiry-row-pending' : '');
            return `<tr onclick="openChatFromMaster('${inq.carId}', '${inq.phone}')" class="cursor-pointer hover:bg-slate-50 transition-all divide-x divide-slate-100 ${rowClass}">
                <td class="text-center py-4">${isPending ? '<span class="pending-badge">회신대기</span>' : '<span class="text-[9px] text-slate-400 font-black italic">회신완료</span>'}${inq.carStatus==='계약요청'?'<div class="mt-1"><span class="request-badge">계약요청</span></div>':''}</td>
                <td class="text-center font-black text-blue-600 text-[11px]">${inq.phone}</td>
                <td class="text-center font-bold text-slate-800">${inq.carId}</td>
                <td class="px-4 text-left"><div class="text-[11px] font-medium text-slate-700 truncate max-w-md">${inq.lastMsg || '...'}</div></td>
                <td class="text-center font-bold text-slate-400 text-[10px]">${inq.carModel}</td>
                <td class="text-center text-[9px] text-slate-300 font-medium">${inq.timestamp ? new Date(inq.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : ''}</td>
            </tr>`;
        }).join('');
        lucide.createIcons();
    }

    window.openChatFromMaster = (carId, phone) => {
        selectedId = carId;
        currentInquiryPhone = phone;
        selectCar(carId, true); 
    };

    window.selectCar = (id, forceChatOpen = false) => {
        selectedId = id;
        const car = rawCars.find(c => c.id === id);
        if (!car) return;

        const infoArea = document.getElementById('drawer-info-area');
        const actionBtn = me.role === 'sales' 
            ? `<button onclick="startInquiryFromDrawer('${car.id}')" class="w-full py-4 bg-blue-600 text-white font-black rounded-2xl shadow-lg flex items-center justify-center gap-2 hover:bg-blue-700 transition-all"><i data-lucide="message-square" class="w-5 h-5"></i> 실시간 문의하기</button>`
            : `<button onclick="startInquiryFromDrawer('${car.id}')" class="w-full py-4 bg-slate-800 text-white font-black rounded-2xl shadow-lg flex items-center justify-center gap-2 hover:bg-slate-700 transition-all"><i data-lucide="message-square" class="w-5 h-5"></i> 실시간 문의 응대하기</button>`;

        infoArea.innerHTML = `
            <div class="h-[50px] border-b flex justify-between items-center px-4 bg-slate-50">
                <span class="font-black text-slate-700 text-[12px] flex items-center gap-2"><i data-lucide="car" class="text-blue-500"></i> ${car.id} 매물 정보</span>
                <button onclick="closeDrawer()" class="p-1 text-slate-400 hover:text-slate-800"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-white">
                <div class="border rounded-3xl p-6 bg-white shadow-sm space-y-3">
                    <div class="flex justify-between items-start">
                        <div><h2 class="text-2xl font-black text-slate-900 leading-tight">${car.모델}</h2><p class="text-blue-600 font-bold text-[12px] mt-1">${car.제조사} | ${car.연료} | ${parseInt(car.주행거리 || 0).toLocaleString()}km</p></div>
                        <span class="px-2.5 py-1 bg-blue-600 text-white text-[9px] font-black rounded-lg uppercase shadow-sm">${car.상태}</span>
                    </div>
                    <div class="pt-4 text-[11px] leading-relaxed text-slate-500 font-medium bg-slate-50/50 p-4 rounded-2xl border border-slate-100">${car.세부사양 || '사양 미등록'}</div>
                </div>
                <div class="border rounded-3xl overflow-hidden bg-white shadow-sm text-[11px]">
                    <div class="bg-slate-50 px-5 py-3 font-black text-slate-500 text-[10px] uppercase">Rental Pricing</div>
                    <div class="p-5 divide-y divide-slate-100">
                        <div class="py-3 flex justify-between items-center"><span>36개월</span><b class="text-blue-700 font-black">${car.금액_대여료_36M || '-'}원 / 보:${car.금액_보증금_36M || '-'}</b></div>
                        <div class="py-3 flex justify-between items-center"><span>48개월</span><b class="text-blue-700 font-black">${car.금액_대여료_48M || '-'}원 / 보:${car.금액_보증금_48M || '-'}</b></div>
                    </div>
                </div>
                <div class="text-[9px] text-slate-300 font-bold px-4 uppercase">Supplier ID: ${car.공급사 || 'Unknown'}</div>
            </div>
            <div class="p-5 border-t bg-white">${actionBtn}</div>
        `;
        
        document.getElementById('detail-drawer').classList.remove('translate-x-full');
        // 관제 시나리오: 관리자/공급사는 문의자가 선택되어 있거나 강제로 열 때 채팅창 활성화
        if (forceChatOpen || (me.role !== 'sales' && currentInquiryPhone)) startInquiryFromDrawer(id);
        else toggleDrawerChat(false);
        
        renderMainList();
        lucide.createIcons();
    };

    window.startInquiryFromDrawer = (id) => {
        selectedId = id;
        const car = rawCars.find(c => c.id === id);
        if (me.role === 'sales') currentInquiryPhone = me.phone;
        
        if (!currentInquiryPhone && me.role !== 'sales') {
            const inqs = Object.keys(car.inquiryList || {});
            if (inqs.length > 0) currentInquiryPhone = inqs[0];
            else return showMessage('문의 중인 내역이 없습니다.');
        }

        document.getElementById('drawer-chat-title').innerText = me.role === 'sales' ? "실시간 문의하기" : "실시간 문의 응대 (관제)";
        document.getElementById('drawer-chat-target').innerText = `상대: ${currentInquiryPhone}`;
        
        const appHeader = document.getElementById('drawer-approval-header');
        // 관리자와 공급사 모두 승인 권한 부여
        if (me.role !== 'sales') {
            appHeader.classList.remove('hidden');
            document.getElementById('drawer-approval-status').innerText = car.상태;
            const action = document.getElementById('drawer-approval-action');
            if (car.상태 === '계약요청' || car.상태 === '대여가능') {
                action.innerHTML = `<button onclick="updateStatus('${id}', '계약완료')" class="approval-btn w-full py-3 bg-emerald-500 text-white font-black rounded-xl text-[11px] shadow-lg flex items-center justify-center gap-2"><i data-lucide="check-circle"></i> 계약 승인 처리</button>`;
            } else {
                action.innerHTML = `<div class="text-center py-2 bg-slate-50 rounded-xl text-[10px] font-bold text-slate-400 uppercase tracking-widest">Process Complete</div>`;
            }
        } else {
            appHeader.classList.add('hidden');
        }

        toggleDrawerChat(true);
        loadChats(id);
    };

    window.toggleDrawerChat = (show) => {
        const drawer = document.getElementById('detail-drawer');
        const chatArea = document.getElementById('drawer-chat-area');
        if (show) { drawer.style.width = '840px'; chatArea.style.width = '380px'; }
        else { drawer.style.width = '460px'; chatArea.style.width = '0px'; }
        lucide.createIcons();
    };

    function loadChats(carId) {
        if (!auth.currentUser || !carId || !currentInquiryPhone) return;
        if(chatUnsubscribe) chatUnsubscribe();
        
        const chatCol = collection(db, ...BASE_PATH.split('/').filter(p => p), carId, "chats");
        chatUnsubscribe = onSnapshot(chatCol, (snap) => {
            const box = document.getElementById('drawer-chat-messages');
            box.innerHTML = '';
            const threadMsgs = []; 
            snap.forEach(d => { if(d.data().salespersonId === currentInquiryPhone) threadMsgs.push(d.data()); });
            threadMsgs.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
            
            if (threadMsgs.length === 0) {
                box.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-slate-300 text-center px-8 italic">문의 대화 내역이 없습니다.</div>`;
            } else {
                threadMsgs.forEach(m => {
                    const d = document.createElement('div');
                    const isMe = m.senderId === me.id;
                    d.className = `chat-bubble ${isMe ? 'bubble-me' : 'bubble-other'}`;
                    d.innerHTML = `<div class="text-[7px] opacity-70 mb-1 font-bold">${isMe ? '나' : (me.role === 'admin' ? '운영팀' : '상대')}</div><div>${m.text}</div>`;
                    box.appendChild(d);
                });
                box.scrollTop = box.scrollHeight;
            }
            lucide.createIcons();
        });
    }

    window.sendMsgFromDrawer = async () => {
        const input = document.getElementById('drawer-chat-input');
        const text = input.value.trim(); if(!text || !selectedId || !currentInquiryPhone) return;
        try {
            await addDoc(collection(db, ...BASE_PATH.split('/').filter(p => p), selectedId, "chats"), { 
                text, senderId: me.id, salespersonId: currentInquiryPhone, timestamp: serverTimestamp() 
            });
            const carDoc = doc(db, ...BASE_PATH.split('/').filter(p => p), selectedId);
            const carSnap = await getDoc(carDoc);
            const inqs = (carSnap.exists() && carSnap.data().inquiryList) ? carSnap.data().inquiryList : {};
            
            // 영업자가 보내면 pending(공급사/관리자 대기), 관리자나 공급사가 보내면 answered(회신완료)
            inqs[currentInquiryPhone] = { status: me.role === 'sales' ? 'pending' : 'answered', lastMsg: text, timestamp: Date.now() };
            await updateDoc(carDoc, { inquiryList: inqs });
            input.value = '';
        } catch (e) { showMessage('전송 실패'); }
    };

    window.switchTab = (tab) => {
        currentTab = tab;
        document.getElementById('inventory-view').classList.toggle('hidden', tab !== 'inventory');
        document.getElementById('chats-view').classList.toggle('hidden', tab !== 'chats');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${tab}-btn`).classList.add('active');
        if (tab === 'chats') renderMasterInquiryList();
        lucide.createIcons();
    };

    window.updateStatus = async (id, status) => {
        if(!confirm(`매물 상태를 '${status}'로 변경하시겠습니까?`)) return;
        await updateDoc(doc(db, ...BASE_PATH.split('/').filter(p => p), id), { 상태: status });
        showMessage('변경 완료');
        startInquiryFromDrawer(id);
    };

    window.saveNewCar = async () => {
        const no = document.getElementById('reg-no').value.trim(); if(!no) return;
        const saveBtn = document.getElementById('save-btn'); saveBtn.disabled = true;
        try {
            await setDoc(doc(db, ...BASE_PATH.split('/').filter(p => p), no), { 
                모델: document.getElementById('reg-model').value, 
                제조사: document.getElementById('reg-brand').value,
                주행거리: document.getElementById('reg-mileage').value, 
                연료: document.getElementById('reg-fuel').value,
                금액_대여료_36M: document.getElementById('reg-36m').value, 
                금액_보증금_36M: document.getElementById('reg-36d').value,
                금액_대여료_48M: document.getElementById('reg-48m').value, 
                금액_보증금_48M: document.getElementById('reg-48d').value,
                세부사양: document.getElementById('reg-spec').value,
                상태: '대여가능', 공급사: me.id, timestamp: serverTimestamp(), inquiryList: {} 
            });
            showMessage('등록 완료'); closeRegModal();
        } catch(e) { showMessage('등록 실패'); } finally { saveBtn.disabled = false; }
    };

    window.handleSearch = (v) => { currentSearch = v; renderMainList(); };
    window.closeDrawer = () => { document.getElementById('detail-drawer').classList.add('translate-x-full'); toggleDrawerChat(false); selectedId = null; currentInquiryPhone = ''; renderMainList(); };
    window.openRegModal = () => document.getElementById('reg-modal').classList.remove('hidden');
    window.closeRegModal = () => document.getElementById('reg-modal').classList.add('hidden');
</script>
</body>
</html>
