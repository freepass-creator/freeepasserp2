<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>프리패스모빌리티 통합 ERP v125</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css');
        
        * { 
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale; 
            text-rendering: optimizeLegibility; 
            box-sizing: border-box;
        }
        body { 
            font-family: 'Pretendard', sans-serif; 
            font-size: 11px; 
            font-weight: 400;
            background-color: #f0f7ff; 
            color: #334155; 
            letter-spacing: -0.025em; 
            line-height: 1.6; 
        }

        .rounded-sm-custom { border-radius: 2px; }
        .box-shadow-premium { box-shadow: 0 10px 25px -5px rgba(0, 104, 183, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05); }
        .selected-row { background-color: #eff6ff !important; border-left: 4px solid #0068b7 !important; }

        /* 표준 닫기 버튼 */
        .btn-close-standard { color: #94a3b8; transition: color 0.2s; cursor: pointer; }
        .btn-close-standard:hover { color: #f43f5e; }

        /* 테이블 헤더 정밀 레이아웃 */
        thead th { font-weight: 700; color: #64748b; background: #f8fafc; font-size: 10px; border-bottom: 1px solid #e2e8f0; white-space: nowrap; height: 56px; padding: 0 !important; }
        thead th:hover { background-color: #f1f5f9; }
        .header-cell-inner { display: flex; align-items: center; width: 100%; height: 100%; cursor: pointer; padding: 0 12px; position: relative; }
        .header-text { flex: 1; text-align: center; margin-left: 14px; } 
        .header-icon-box { width: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

        tbody td { font-weight: 400; height: 56px; border-bottom: 1px solid #f1f5f9; font-size: 11px; text-align: center; }

        /* [v125] 상품 리스트 영역 안에서만 움직이는 독립 스크롤부 */
        .scroller-always { 
            overflow-x: auto !important; 
            overflow-y: auto !important; 
            height: 100%; 
            width: 100%; 
            max-width: 100%; 
            display: block; 
            position: relative;
            background: white;
            border-top: 1px solid #f1f5f9;
        }
        .scroller-always::-webkit-scrollbar { width: 8px; height: 8px; }
        .scroller-always::-webkit-scrollbar-track { background: #f8fafc; }
        .scroller-always::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; border: 2px solid #f8fafc; }

        #content-area { flex: 1; min-width: 0; display: flex; flex-direction: column; overflow: hidden; position: relative; }

        .tab-btn.active { background-color: #eff6ff; color: #0068b7; font-weight: 600; border-radius: 4px; }
        .notif-dot { width: 7px; height: 7px; background-color: #0068b7; border-radius: 50%; position: absolute; top: 6px; right: 6px; box-shadow: 0 0 8px rgba(0, 104, 183, 0.6); }

        .tactile-filter-btn { transition: all 0.1s; border: 1px solid #d1e3f8; cursor: pointer; background: white; color: #64748b; font-weight: 700; position: relative; text-align: center; box-shadow: 0 2px 0 #d1e3f8; }
        .tactile-filter-btn:active { transform: translateY(1px); box-shadow: 0 1px 0 #d1e3f8; }

        .role-bar-sales { border-left: 4px solid #0068b7 !important; }
        .role-bar-supplier { border-left: 4px solid #10b981 !important; }
        .role-bar-admin { border-left: 4px solid #f43f5e !important; }

        #detail-drawer { transition: transform 0.35s cubic-bezier(0.25, 1, 0.5, 1), width 0.3s ease; display: flex; gap: 8px; background-color: transparent !important; }
        .drawer-sub-panel { background: white; box-shadow: -10px 0 25px -5px rgba(0,0,0,0.1); border-left: 1px solid #e2e8f0; height: 100%; overflow: hidden; }

        .filter-popup { position: absolute; background: white; border: 1px solid #e2e8f0; box-shadow: 0 15px 35px rgba(0,0,0,0.15); z-index: 1000; width: 220px; padding: 12px; border-radius: 2px; }
    </style>
</head>
<body class="h-screen overflow-hidden select-none text-slate-700">

<div id="toast">알림 메시지</div>

<!-- 보안 게이트 -->
<div id="gate" class="fixed inset-0 bg-gradient-to-br from-[#0f172a] to-[#1e293b] z-[9999] flex flex-col items-center justify-center p-6 text-center font-sans">
    <div class="max-w-md w-full animate-drawer space-y-10">
        <div class="space-y-3">
            <h1 class="text-3xl font-black tracking-tight text-white">반갑습니다!</h1>
            <p class="text-slate-400 font-bold uppercase tracking-tighter text-sm">장기렌터카 통합 ERP 보안 시스템</p>
        </div>
        <div class="space-y-6 text-left">
            <div class="bg-white/5 p-8 rounded-sm border border-white/10 space-y-6 box-shadow-premium">
                <div class="space-y-4">
                    <p class="text-[11px] text-blue-400 font-black uppercase tracking-widest border-l-4 border-blue-500 pl-2">전산 인증</p>
                    <input type="text" id="user-id-input" placeholder="ID (전산번호)" class="w-full p-4 bg-slate-800 border border-slate-700 text-white text-sm font-bold focus:border-blue-500 outline-none transition-all">
                    <!-- 지시: 참고 코드처럼 보안코드 7777 선입력 및 가이드 적용 -->
                    <input type="password" id="user-pw" value="7777" placeholder="****" maxlength="4" class="w-full p-4 bg-slate-800 border border-slate-700 text-white text-center text-2xl tracking-[0.5em] focus:border-blue-500 outline-none transition-all" onkeypress="if(event.key==='Enter') window.login()">
                </div>
                <button id="login-btn" onclick="window.login()" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-black text-sm tracking-widest transition-all shadow-lg active:translate-y-1">시스템 접속하기</button>
            </div>
            <div class="text-center">
                <button onclick="window.openSignupModal()" class="text-slate-500 hover:text-blue-400 text-[11px] font-bold transition-colors underline underline-offset-4">신규 회원가입 신청</button>
            </div>
        </div>
    </div>
</div>

<!-- 회원가입 모달 -->
<div id="signup-modal" class="fixed inset-0 bg-slate-900/80 z-[10000] hidden flex items-center justify-center p-6 backdrop-blur-sm">
    <div class="bg-white p-8 rounded-sm-custom max-w-md w-full space-y-6 shadow-2xl">
        <div class="flex justify-between items-center">
            <h3 class="text-xl font-bold text-slate-800">회원가입 신청</h3>
            <button onclick="window.closeSignupModal()" class="btn-close-standard"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
        <div class="space-y-4">
            <div class="grid grid-cols-2 gap-3">
                <input type="text" id="reg-name" placeholder="성함" class="p-3 bg-slate-50 border border-slate-100 rounded-sm text-[11px] outline-none">
                <select id="reg-role" class="p-3 bg-white border border-slate-100 rounded-sm text-[11px] outline-none">
                    <option value="sales">영업자 신청</option>
                    <option value="supplier">공급사 신청</option>
                </select>
            </div>
            <input type="text" id="reg-id" placeholder="연락처 (아이디)" class="w-full p-3 bg-slate-50 border border-slate-100 rounded-sm text-[11px] outline-none">
            <input type="text" id="reg-company" placeholder="회사명" class="w-full p-3 bg-slate-50 border border-slate-100 rounded-sm text-[11px] outline-none">
        </div>
        <button onclick="window.submitSignup()" class="w-full py-4 bg-slate-800 text-white font-bold rounded-sm text-[12px]">신청하기</button>
    </div>
</div>

<!-- 메인 앱 -->
<div id="app" class="hidden h-screen flex flex-col overflow-hidden bg-[#f1f3f6] opacity-0 transition-opacity duration-700">
    <header class="h-[56px] bg-white border-b border-slate-200 flex items-center px-6 justify-between z-50 shadow-sm text-slate-800 text-nowrap">
        <div class="flex items-center gap-6">
            <div id="top-user-info-container" class="flex items-center gap-4 text-nowrap">
                <div id="role-bar" class="flex items-baseline gap-2 pl-3">
                    <span id="name-tag" class="font-bold text-slate-800 text-[11px]">사용자</span>
                    <span id="id-tag" class="font-medium text-slate-400 text-[10px]">ID</span>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-5 text-nowrap">
            <div class="relative flex items-center">
                <i data-lucide="search" class="absolute left-3 text-slate-400 w-3.5 h-3.5"></i>
                <input type="text" id="searchInput" oninput="window.handleSearch(this.value)" placeholder="매물 통합 검색..." class="pl-9 pr-4 py-2 border border-slate-200 rounded-none text-[11px] focus:border-blue-400 outline-none w-72 bg-slate-50 font-medium">
            </div>
            <button onclick="location.reload()" class="text-slate-400 font-medium hover:text-rose-500 text-[11px] flex items-center gap-1.5 transition-colors ml-2">
                <i data-lucide="log-out" class="w-3.5 h-3.5"></i> 로그아웃
            </button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        <nav class="w-[92px] bg-white border-r border-slate-200 flex flex-col items-center py-6 gap-5 z-40 shadow-sm text-slate-400 text-nowrap">
            <button onclick="window.switchTab('inventory')" id="tab-inventory-btn" class="tab-btn w-18 h-16 flex flex-col items-center justify-center rounded-sm transition-all relative">
                <i data-lucide="layout-grid" class="w-6 h-6"></i>
                <span class="text-[11px] font-bold mt-1.5">상품현황</span>
            </button>
            <button onclick="window.switchTab('chats')" id="tab-chats-btn" class="tab-btn w-18 h-16 flex flex-col items-center justify-center rounded-sm transition-all relative">
                <i data-lucide="message-square" class="w-6 h-6"></i>
                <span id="tab-chat-label" class="text-[11px] font-bold mt-1.5 text-center leading-none">문의내역</span>
                <div id="unread-dot" class="notif-dot hidden"></div>
            </button>
            <button onclick="window.switchTab('members')" id="tab-members-btn" class="tab-btn w-18 h-16 flex flex-col items-center justify-center rounded-sm transition-all relative hidden">
                <i data-lucide="users" class="w-6 h-6"></i>
                <span class="text-[11px] font-bold mt-1.5 text-center leading-none">회원관리</span>
            </button>
            <div class="h-px w-10 bg-slate-100 my-2"></div>
            <div class="flex flex-col gap-3 w-full px-2" id="sidebar-filters">
                <div class="relative"><button onclick="window.openSidebarFilter('period', this)" class="tactile-filter-btn w-full py-2.5 text-[10px] rounded-sm text-nowrap">기간</button><div id="dot-period" class="active-dot hidden"></div></div>
                <div class="relative"><button onclick="window.openSidebarFilter('rental', this)" class="tactile-filter-btn w-full py-2.5 text-[10px] rounded-sm text-nowrap">대여료</button><div id="dot-rental" class="active-dot hidden"></div></div>
                <div class="relative"><button onclick="window.openSidebarFilter('deposit', this)" class="tactile-filter-btn w-full py-2.5 text-[10px] rounded-sm text-nowrap">보증금</button><div id="dot-deposit" class="active-dot hidden"></div></div>
                <div class="relative"><button onclick="window.openSidebarFilter('mileage', this)" class="tactile-filter-btn w-full py-2.5 text-[10px] rounded-sm text-nowrap">주행거리</button><div id="dot-mileage" class="active-dot hidden"></div></div>
                <div class="relative"><button onclick="window.openSidebarFilter('year', this)" class="tactile-filter-btn w-full py-2.5 text-[10px] rounded-sm text-nowrap">연식</button><div id="dot-year" class="active-dot hidden"></div></div>
            </div>
            <div class="mt-auto space-y-4 pb-2 text-nowrap">
                <button id="excel-btn" onclick="window.showMessage('전산 매물 엑셀 생성 중...')" class="hidden w-16 h-10 flex items-center justify-center gap-1.5 rounded-sm bg-white text-emerald-600 border border-emerald-600 hover:bg-emerald-50 transition-all shadow-sm">
                    <i data-lucide="file-spreadsheet" class="w-3.5 h-3.5"></i>
                    <span class="text-[9px] font-black tracking-tighter uppercase">EXCEL</span>
                </button>
            </div>
        </nav>

        <section id="content-area">
            <div id="inventory-view" class="flex-1 flex flex-col bg-white h-full overflow-hidden" onclick="window.handleOutsideClick(event)">
                <div class="h-12 bg-white border-b border-slate-100 flex items-center px-6 justify-between text-nowrap flex-shrink-0">
                    <div class="flex items-center gap-3">
                        <span class="text-[12px] font-black text-slate-700">차량 상품 리스트</span>
                        <span class="text-[12px] font-black text-[#0068b7] ml-1 text-nowrap"><span id="total-count-txt">0</span>대</span>
                        <div id="inventory-manage-controls" class="hidden ml-4 flex gap-2">
                            <button onclick="window.openAddCarModal()" class="px-5 py-2 bg-[#0068b7] text-white font-bold text-[10px] rounded-sm hover:bg-[#005696] shadow-sm transition-all flex items-center gap-2">
                                <i data-lucide="plus-circle" class="w-3.5 h-3.5"></i> 상품 등록
                            </button>
                            <button id="admin-bulk-delete-btn" onclick="window.openDeleteConfirm(null, 'bulk')" class="hidden px-5 py-2 bg-rose-600 text-white font-bold text-[10px] rounded-sm hover:bg-rose-700 shadow-sm transition-all">
                                필터 결과 전체 삭제
                            </button>
                        </div>
                    </div>
                </div>
                <!-- 상품 리스트 전용 가로 스크롤 영역 (딱 여기만 움직임) -->
                <div id="main-scroll-area" class="flex-1 min-h-0 scroller-always">
                    <table class="w-full border-collapse min-w-[1600px] text-nowrap">
                        <thead class="sticky top-0 z-10 shadow-sm bg-[#f8f9fb]">
                            <tr id="main-table-header" class="divide-x divide-slate-200 text-[10px] uppercase font-bold text-nowrap"></tr>
                        </thead>
                        <tbody id="main-list-body" class="divide-y divide-slate-100 text-center text-nowrap"></tbody>
                    </table>
                </div>
            </div>

            <!-- 문의내역 뷰 -->
            <div id="chats-view" class="hidden flex-1 flex flex-col bg-white h-full overflow-hidden">
                <div class="h-10 bg-white border-b border-slate-100 flex items-center px-6 justify-between text-nowrap flex-shrink-0">
                    <span id="chat-header-title" class="text-[10px] font-bold text-slate-700 uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="activity" class="w-3.5 h-3.5 text-rose-500"></i> 대화 내역
                    </span>
                </div>
                <div class="flex-1 overflow-auto bg-slate-50 text-nowrap">
                    <table class="w-full border-collapse table-fixed min-w-[900px]">
                        <thead class="sticky top-0 z-10 shadow-sm bg-[#f8f9fb]">
                            <tr class="divide-x divide-slate-100 text-[10px] uppercase text-center text-slate-500 font-bold">
                                <th class="w-20 py-4">처리상태</th>
                                <th class="w-36">사용자 아이디</th>
                                <th class="w-32">대상 차량번호</th>
                                <th class="text-left px-5 font-semibold text-slate-700">최신 대화 내용</th>
                                <th class="w-32">차종 정보</th>
                                <th class="w-24 text-center">수신시간</th>
                                <th class="w-16 text-center">관리</th>
                            </tr>
                        </thead>
                        <tbody id="master-inquiry-list" class="divide-y divide-slate-100 bg-white text-center"></tbody>
                    </table>
                </div>
            </div>

            <!-- 상세 Drawer -->
            <div id="detail-drawer" onmouseenter="window.toggleMainScroll(false)" onmouseleave="window.toggleMainScroll(true)" class="absolute right-0 top-0 h-full w-[460px] transform translate-x-full z-[100] text-slate-800 text-nowrap">
                <div id="drawer-chat-area" class="w-0 drawer-sub-panel flex flex-col bg-[#f8fafc] text-nowrap">
                    <div class="h-[52px] border-b bg-slate-50 flex items-center px-5 justify-between">
                        <div class="flex flex-col text-left">
                            <span id="drawer-chat-title" class="font-bold text-[#0068b7] text-[11px]">실시간 문의 대화</span>
                            <span id="drawer-chat-target" class="text-[9px] font-medium text-slate-400 uppercase tracking-tighter">상대: -</span>
                        </div>
                        <button onclick="window.toggleDrawerChat(false)" class="btn-close-standard"><i data-lucide="chevrons-right" class="w-5 h-5"></i></button>
                    </div>
                    <div id="drawer-chat-messages" class="flex-1 overflow-y-auto p-5 flex flex-col gap-4 text-nowrap"></div>
                    <div class="h-[80px] p-4 border-t bg-white flex items-center gap-2">
                        <input type="text" id="drawer-chat-input" placeholder="메시지 입력..." class="flex-1 h-full px-4 border border-slate-200 rounded-sm outline-none focus:border-blue-500 text-[11px]" onkeypress="if(event.key==='Enter') window.sendMsgFromDrawer()">
                        <button onclick="window.sendMsgFromDrawer()" class="h-full bg-[#0068b7] text-white px-5 rounded-sm font-bold transition-all">전송</button>
                    </div>
                </div>
                <div id="drawer-info-area" class="w-[460px] drawer-sub-panel flex flex-col bg-white text-nowrap text-nowrap">
                    <div class="h-[52px] border-b flex justify-between items-center px-6 bg-slate-50 text-left">
                        <span class="font-bold text-slate-700 text-[12px] flex items-center gap-2 uppercase tracking-tighter"><i data-lucide="car" class="text-blue-500 w-4 h-4"></i> 차량 상세 명세서</span>
                        <button onclick="window.closeDrawer()" class="btn-close-standard"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    <div id="detail-content-inner" class="flex-1 overflow-y-auto p-5 space-y-4 hide-scrollbar bg-[#f8fafc]"></div>
                    <div id="drawer-footer" class="h-[80px] p-4 border-t bg-white flex items-center gap-2"></div>
                </div>
            </div>
        </section>
    </main>
</div>

<!-- 팝업 모달들 -->
<div id="filter-popup" class="filter-popup hidden box-shadow-premium border border-slate-200 text-nowrap">
    <div class="flex justify-between items-center mb-3 pb-2 border-b">
        <span id="filter-title" class="font-bold text-[10px] text-[#0068b7]">필터 설정</span>
        <button onclick="window.closeFilterPopup()" class="btn-close-standard"><i data-lucide="x" class="w-3.5 h-3.5"></i></button>
    </div>
    <div id="filter-options" class="flex flex-col gap-1 max-h-60 overflow-y-auto hide-scrollbar text-nowrap"></div>
    <div class="mt-3 pt-3 border-t flex gap-2">
        <button onclick="window.applyFilters()" class="flex-1 bg-[#0068b7] text-white py-1.5 rounded-sm font-bold text-[10px]">적용</button>
        <button id="filter-reset-btn" class="flex-1 bg-slate-100 text-slate-500 py-1.5 rounded-sm font-bold text-[10px]">초기화</button>
    </div>
</div>

<div id="delete-confirm-modal" class="fixed inset-0 bg-slate-900/80 z-[20000] hidden flex items-center justify-center p-6 backdrop-blur-sm text-nowrap">
    <div class="bg-white p-8 rounded-sm-custom max-w-xs w-full text-center space-y-6 shadow-2xl border border-white">
        <div class="w-12 h-12 bg-rose-50 text-rose-600 rounded-full flex items-center justify-center mx-auto"><i data-lucide="alert-triangle" class="w-6 h-6"></i></div>
        <h3 id="del-confirm-title" class="text-lg font-bold text-slate-800 text-nowrap">항목을 삭제할까요?</h3>
        <div class="flex gap-2">
            <button id="del-confirm-btn" onclick="window.applyDelete()" class="flex-1 py-3 bg-rose-600 text-white font-bold rounded-sm text-[12px] text-nowrap">삭제하기</button>
            <button onclick="window.closeDeleteConfirm()" class="flex-1 py-3 bg-slate-100 text-slate-500 font-bold rounded-sm text-[12px] text-nowrap">취소</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc, getDoc, getDocs, addDoc, serverTimestamp, query, orderBy, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // [v125] 외부 환경 접속 지원 (Vercel/Github)
    const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) ? JSON.parse(__firebase_config) : { apiKey: "DEMO_MODE" };
    const appId = (typeof __app_id !== 'undefined' && __app_id) ? __app_id : 'freepass-erp-v125';
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ACCOUNT_MAP = {
        "1111": { role: "sales", name: "홍길동", company: "우리렌트" },
        "2222": { role: "sales", name: "김철수", company: "베스트영업" },
        "3333": { role: "supplier", name: "박영희", company: "제일모빌리티" },
        "4444": { role: "supplier", name: "이영수", company: "가온캐피탈" },
        "5555": { role: "admin", name: "마스터", company: "프리패스모빌리티" }
    };

    const PERMISSIONS = {
        CAN_MANAGE_INVENTORY: (role) => ['admin', 'supplier'].includes(role),
        CAN_MANAGE_MEMBERS: (role) => role === 'admin',
        CAN_BULK_DELETE: (role) => role === 'admin',
        CAN_EXPORT_EXCEL: (role) => ['admin', 'supplier', 'sales'].includes(role)
    };

    // 전역 상태
    let me = { id: '', role: 'sales', phone: '', company: '', nameTitle: '' };
    let rawCars = [];
    let selectedId = null;
    let currentInquiryPhone = '';
    let currentTab = 'inventory';
    let chatUnsubscribe = null;
    let currentSearch = "";
    let itemToDelete = null;
    let headerFilters = { 상태: [], 구분: [], 세부모델: [], 외부색상: [], 내부색상: [], 제조사: [], 모델: [] };
    let sidebarFilters = { period: ['36M', '48M', '60M'], rental: [], deposit: [], mileage: [], year: [] };
    let sortState = { key: '', order: '' };

    // [v125 핵심] 모든 내부 함수 최상단 고정 (ReferenceError 방어)
    const getVisibleCars = () => {
        let f = (me.role === 'supplier') ? rawCars.filter(c => String(c.공급사) === String(me.id)) : rawCars;
        if (currentSearch) f = f.filter(c => JSON.stringify(c).toLowerCase().includes(currentSearch.toLowerCase()));
        Object.keys(headerFilters).forEach(k => { if (headerFilters[k] && headerFilters[k].length > 0) f = f.filter(c => headerFilters[k].includes(String(c[k] || '-'))); });
        Object.keys(sidebarFilters).forEach(k => {
            const activeOptions = sidebarFilters[k] || [];
            if (activeOptions.length > 0 && k !== 'period') {
                if (k === 'rental') {
                    f = f.filter(c => {
                        const price = parseInt(String(c.금액_대여료_36M || '0').replace(/[^0-9]/g, '')) || 0;
                        return activeOptions.some(range => {
                            const p = range.split('~'); return price >= (parseInt(p[0]) * 10000) && price <= (parseInt(p[1]) * 10000);
                        });
                    });
                } else { f = f.filter(c => activeOptions.includes(String(c[k] || '-'))); }
            }
        });
        return f;
    };

    const maskId = (id) => { if(!id) return ""; const str = String(id); return str.length > 4 ? `***-***-${str.slice(-4)}` : str; };

    // 전역 함수 바인딩
    window.updateFilterDots = () => { 
        ['period', 'rental', 'deposit', 'mileage', 'year'].forEach(f => { 
            const dot = document.getElementById('dot-' + f); 
            if(dot) dot.classList.toggle('hidden', (sidebarFilters[f] || []).length === 0 || (f === 'period' && (sidebarFilters.period || []).length === 3)); 
        }); 
    };
    window.showMessage = (msg) => { const t = document.getElementById("toast"); if(t) { t.innerText = msg; t.classList.add("show"); setTimeout(() => { t.classList.remove("show"); }, 3000); }};
    window.openSignupModal = () => document.getElementById('signup-modal')?.classList.remove('hidden');
    window.closeSignupModal = () => document.getElementById('signup-modal')?.classList.add('hidden');
    window.submitSignup = () => { window.showMessage("회원가입 신청이 완료되었습니다."); window.closeSignupModal(); };
    window.handleOutsideClick = (e) => { if (selectedId && !e.target.closest('#detail-drawer') && !e.target.closest('tr')) window.closeDrawer(); };
    window.toggleMainScroll = (enable) => { const area = document.getElementById('main-scroll-area'); if (area) area.style.overflow = enable ? 'auto' : 'hidden'; };
    
    window.closeFilterPopup = () => { 
        const p = document.getElementById('filter-popup'); 
        if(p) { p.classList.add('hidden'); p.removeAttribute('data-key'); p.removeAttribute('data-type'); } 
    };

    window.handleSearch = (v) => { currentSearch = v; window.renderUI(); };
    window.openAddCarModal = () => window.showMessage("신규 상품 등록 모듈이 활성화됩니다.");
    window.toggleSort = (k, e) => { if(e) e.stopPropagation(); if (sortState.key === k) sortState.order = sortState.order === 'asc' ? 'desc' : (sortState.order === 'desc' ? '' : 'asc'); else { sortState.key = k; sortState.order = 'asc'; } window.renderUI(); };
    
    window.openDeleteConfirm = (id, type = 'car', phone = null) => {
        itemToDelete = { id, type, phone };
        const titleEl = document.getElementById('del-confirm-title');
        const btnEl = document.getElementById('del-confirm-btn');
        if (!titleEl || !btnEl) return;
        if (type === 'bulk') { titleEl.innerText = `필터된 상품 ${getVisibleCars().length}대를 일괄 삭제할까요?`; btnEl.onclick = window.applyBulkDelete; }
        else if (type === 'car') { titleEl.innerText = "이 상품을 전산에서 삭제할까요?"; btnEl.onclick = window.applyCarDelete; }
        else { titleEl.innerText = "이 대화 내역을 삭제할까요?"; btnEl.onclick = window.applyChatDelete; }
        document.getElementById('delete-confirm-modal')?.classList.remove('hidden');
    };
    window.closeDeleteConfirm = () => { itemToDelete = null; document.getElementById('delete-confirm-modal')?.classList.add('hidden'); };

    window.applyBulkDelete = async () => {
        if (!auth.currentUser && firebaseConfig.apiKey !== "DEMO_MODE") return;
        const targetCars = getVisibleCars();
        try {
            if (firebaseConfig.apiKey !== "DEMO_MODE") {
                const batch = writeBatch(db); targetCars.forEach(car => batch.delete(doc(db, 'artifacts', appId, 'public', 'data', 'cars', car.id))); await batch.commit();
            } else { rawCars = rawCars.filter(c => !targetCars.find(tc => tc.id === c.id)); }
            window.closeDeleteConfirm(); window.showMessage(`일괄 삭제 완료`); window.renderUI();
        } catch (e) { window.showMessage("삭제 실패"); }
    };

    window.applyCarDelete = async () => {
        if (!auth.currentUser && firebaseConfig.apiKey !== "DEMO_MODE") return;
        try {
            if (firebaseConfig.apiKey !== "DEMO_MODE") await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'cars', itemToDelete.id));
            else rawCars = rawCars.filter(c => c.id !== itemToDelete.id);
            window.closeDeleteConfirm(); window.showMessage('상품 삭제 완료'); window.renderUI();
        } catch (e) { window.showMessage("삭제 실패"); }
    };

    window.applyChatDelete = async () => {
        if (!auth.currentUser && firebaseConfig.apiKey !== "DEMO_MODE") return;
        try {
            const carRef = doc(db, 'artifacts', appId, 'public', 'data', 'cars', itemToDelete.id);
            const carSnap = await getDoc(carRef);
            if (carSnap.exists()) {
                const inqs = carSnap.data().inquiryList || {}; delete inqs[itemToDelete.phone];
                await updateDoc(carRef, { inquiryList: inqs }); window.closeDeleteConfirm(); window.showMessage('대화 삭제 완료'); window.renderUI();
            }
        } catch (e) { window.showMessage("삭제 실패"); }
    };

    window.switchTab = (tab) => { 
        currentTab = tab; 
        ['inventory', 'chats', 'members'].forEach(t => { 
            const view = document.getElementById(t + '-view');
            const btn = document.getElementById('tab-' + t + '-btn');
            if(view) view.classList.toggle('hidden', t !== tab); 
            if(btn) btn.classList.toggle('active', t === tab); 
        }); 
        window.renderUI(); 
    };

    window.renderTableHeader = () => {
        const headerRow = document.getElementById('main-table-header'); if(!headerRow) return;
        const getFColor = (k) => (headerFilters[k] && headerFilters[k].length > 0) ? 'text-[#0068b7]' : 'text-slate-300';
        const getSColor = (k) => (sortState.key === k) ? 'text-[#0068b7]' : 'text-slate-300';
        const fI = (k) => `<div class="header-icon-box"><i data-lucide="filter" class="w-3 h-3 ${getFColor(k)}"></i></div>`;
        const sI = (k) => `<div class="header-icon-box"><i data-lucide="${sortState.key===k? (sortState.order==='asc'?'arrow-up':'arrow-down') : 'arrow-up-down'}" class="w-3 h-3 ${getSColor(k)}"></i></div>`;
        const wrapF = (k, label) => `<div class="header-cell-inner" onclick="window.openHeaderFilter('${k}', this, event)"><span class="header-text">${label}</span>${fI(k)}</div>`;
        const wrapS = (k, label) => `<div class="header-cell-inner" onclick="window.toggleSort('금액_대여료_${sidebarFilters.period[0]}', event)"><span class="header-text">${label}</span>${sI(k)}</div>`;

        headerRow.innerHTML = `
            <th class="w-20">${wrapF('상태', '상태')}</th>
            <th class="w-16">${wrapF('구분', '구분')}</th>
            <th class="w-24 text-center"><div class="header-cell-inner justify-center px-0"><span>차량번호</span></div></th>
            <th class="w-24">${wrapF('제조사', '제조사')}</th>
            <th class="w-28">${wrapF('모델', '모델')}</th>
            <th class="w-32">${wrapF('세부모델', '세부모델')}</th>
            <th class="text-left px-5 leading-tight">세부트림<br><small class="opacity-60 font-normal">(선택옵션)</small></th>
            <th class="w-20">${wrapF('외부색상', '외부색상')}</th>
            <th class="w-20">${wrapF('내부색상', '내부색상')}</th>
            <th class="w-24">${wrapF('주행거리', '주행거리')}</th>
            ${sidebarFilters.period.map(p => `<th class="w-36 bg-blue-50 text-[#0068b7] border-l border-blue-100"><div class="header-cell-inner" onclick="window.toggleSort('금액_대여료_${p}', event)"><div class="header-text leading-tight"><div>${p} 대여료</div><div class="text-[8px] opacity-60 font-normal">(보증금)</div></div>${sI(`금액_대여료_${p}`)}</div></th>`).join('')}
            ${PERMISSIONS.CAN_MANAGE_INVENTORY(me.role) ? '<th class="w-14 text-center bg-slate-50">관리</th>' : ''}
        `;
        lucide.createIcons();
    };

    window.renderMainList = () => {
        const body = document.getElementById('main-list-body'); if(!body) return;
        let f = getVisibleCars();
        if (sortState.key && sortState.order) { f.sort((a, b) => { let v1 = a[sortState.key]; let v2 = b[sortState.key]; if (typeof v1 === 'string') v1 = parseInt(v1.replace(/[^0-9]/g, '')) || 0; return sortState.order === 'asc' ? v1 - v2 : v2 - v1; }); }
        body.innerHTML = f.map(c => `<tr class="hover:bg-blue-50/50 transition-all divide-x divide-slate-100 ${selectedId===c.id?'selected-row':''}">
            <td onclick="window.selectCar('${c.id}')" class="py-3 cursor-pointer"><span class="px-1.5 py-0.5 rounded-sm text-[8px] font-bold border ${c.상태==='대여가능'?'bg-emerald-50 text-emerald-600 border-emerald-100':'bg-rose-50 text-rose-600 border-rose-100'} uppercase text-nowrap">${c.상태 || '대여가능'}</span></td>
            <td onclick="window.selectCar('${c.id}')" class="font-medium text-slate-500 cursor-pointer text-nowrap">${c.구분 || '-'}</td>
            <td onclick="window.selectCar('${c.id}')" class="font-bold text-slate-800 cursor-pointer text-nowrap">${c.id}</td>
            <td onclick="window.selectCar('${c.id}')" class="font-medium text-slate-400 cursor-pointer text-nowrap">${c.제조사 || '-'}</td>
            <td onclick="window.selectCar('${c.id}')" class="font-bold text-slate-800 cursor-pointer text-nowrap">${c.모델 || '-'}</td>
            <td onclick="window.selectCar('${c.id}')" class="font-medium text-slate-500 cursor-pointer text-nowrap">${c.세부모델 || '-'}</td>
            <td onclick="window.selectCar('${c.id}')" class="px-5 text-left font-medium text-slate-700 truncate cursor-pointer text-nowrap">${c.세부사양 || c.모델 || '-'}</td>
            <td onclick="window.selectCar('${c.id}')" class="font-medium text-slate-400 cursor-pointer text-nowrap">${c.외부색상 || '-'}</td>
            <td onclick="window.selectCar('${c.id}')" class="font-medium text-slate-400 cursor-pointer text-nowrap">${c.내부색상 || '-'}</td>
            <td onclick="window.selectCar('${c.id}')" class="text-right pr-5 font-medium text-slate-600 cursor-pointer text-nowrap">${parseInt(c.주행거리 || 0).toLocaleString()}km</td>
            ${sidebarFilters.period.map(p => `<td onclick="window.selectCar('${c.id}')" class="bg-blue-50/30 text-right pr-5 font-bold text-[#0068b7] leading-none cursor-pointer text-nowrap"><div>${c[`금액_대여료_${p}`] || '-'}원</div><div class="text-[8px] text-slate-400 font-normal">보: ${c[`금액_보증금_${p}`] || '-'}</div></td>`).join('')}
            ${PERMISSIONS.CAN_MANAGE_INVENTORY(me.role) ? `<td class="py-2 px-1 text-center"><button onclick="window.openDeleteConfirm('${c.id}', 'car')" class="p-1.5 text-slate-300 hover:text-rose-600 transition-all text-nowrap"><i data-lucide="trash-2" class="w-4 h-4 text-nowrap"></i></button></td>` : ''}
        </tr>`).join('');
        lucide.createIcons();
    };

    window.renderMasterInquiryList = () => {
        const container = document.getElementById('master-inquiry-list'); if(!container) return; container.innerHTML = ''; const all = [];
        rawCars.forEach(car => {
            if (me.role === 'supplier' && String(car.공급사) !== String(me.id)) return;
            if (car.inquiryList) { Object.entries(car.inquiryList).forEach(([phone, info]) => { if (me.role === 'sales' && phone !== me.id) return; all.push({ carId: car.id, carModel: car.모델, salespersonPhone: phone, ...info }); }); }
        });
        all.sort((a, b) => (a.status === 'pending' ? -1 : 1) || (b.timestamp || 0) - (a.timestamp || 0));
        if (all.length === 0) { container.innerHTML = `<tr><td colspan="7" class="p-20 text-center text-slate-400 font-medium italic text-nowrap">문의 내역이 없습니다.</td></tr>`; return; }
        container.innerHTML = all.map(i => `<tr class="hover:bg-slate-50 transition-all divide-x divide-slate-100 ${selectedId===i.carId?'selected-row':''} text-nowrap"><td onclick="window.openChatFromMaster('${i.carId}', '${i.salespersonPhone}')" class="py-4 cursor-pointer text-center text-nowrap"><span class="${i.status==='pending'?'pending-badge':'answered-badge'}">${i.status==='pending'?'회신대기':'회신완료'}</span></td><td class="font-bold text-blue-600 text-[11px] text-center text-nowrap">${me.role==='supplier'?maskId(i.salespersonPhone):i.salespersonPhone}</td><td class="font-bold text-slate-800 text-[11px] text-center text-nowrap">${i.carId}</td><td class="px-6 text-left font-medium text-slate-600 truncate cursor-pointer text-nowrap">${i.lastMsg || '대화 활성화'}</td><td class="font-medium text-slate-400 text-[11px] text-center text-nowrap">${i.carModel}</td><td class="text-[9px] text-slate-400 text-center text-nowrap">${i.timestamp ? new Date(i.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '-'}</td><td class="py-2 px-1 text-center"><button onclick="window.openDeleteConfirm('${i.carId}', 'chat', '${i.salespersonPhone}')" class="p-1.5 text-slate-300 hover:text-rose-50 transition-all text-nowrap"><i data-lucide="trash-2" class="w-4 h-4 text-nowrap"></i></button></td></tr>`).join('');
        lucide.createIcons();
    };

    window.renderUI = () => {
        if (!auth.currentUser && firebaseConfig.apiKey !== "DEMO_MODE") return;
        const chatLabel = document.getElementById('tab-chat-label');
        const inventoryManageControls = document.getElementById('inventory-manage-controls');
        const adminBulkDeleteBtn = document.getElementById('admin-bulk-delete-btn');
        const roleBar = document.getElementById('role-bar');
        const unreadDot = document.getElementById('unread-dot');
        const tabMembersBtn = document.getElementById('tab-members-btn');
        const sidebarFiltersDiv = document.getElementById('sidebar-filters');
        
        if (chatLabel) chatLabel.innerText = "문의내역";
        if (tabMembersBtn) tabMembersBtn.classList.toggle('hidden', !PERMISSIONS.CAN_MANAGE_MEMBERS(me.role));
        if (roleBar) roleBar.className = `flex items-baseline gap-2 pl-3 ${me.role === 'sales' ? 'role-bar-sales' : (me.role === 'supplier' ? 'role-bar-supplier' : 'role-bar-admin')}`;
        if (inventoryManageControls) inventoryManageControls.classList.toggle('hidden', !PERMISSIONS.CAN_MANAGE_INVENTORY(me.role));
        if (adminBulkDeleteBtn) adminBulkDeleteBtn.classList.toggle('hidden', !PERMISSIONS.CAN_BULK_DELETE(me.role));
        if (sidebarFiltersDiv) sidebarFiltersDiv.style.display = (currentTab === 'inventory' ? 'flex' : 'none');
        
        let hasUnread = false;
        rawCars.forEach(car => {
            if (me.role === 'supplier' && String(car.공급사) === String(me.id)) { if (car.inquiryList) Object.values(car.inquiryList).forEach(inq => { if(inq.status === 'pending') hasUnread = true; }); }
            if (me.role === 'sales') { if (car.inquiryList && car.inquiryList[me.id] && car.inquiryList[me.id].status === 'answered') hasUnread = true; }
        });
        if (unreadDot) unreadDot.classList.toggle('hidden', !hasUnread);

        document.getElementById('total-count-txt').innerText = getVisibleCars().length;
        window.renderTableHeader();
        window.renderMainList();
        window.updateFilterDots();
        if (currentTab === 'chats') window.renderMasterInquiryList();
    };

    window.openSidebarFilter = (type, btn) => {
        const p = document.getElementById('filter-popup'); if (!p) return;
        if (!p.classList.contains('hidden') && p.getAttribute('data-type') === type) { window.closeFilterPopup(); return; }
        const o = document.getElementById('filter-options'); const rect = btn.getBoundingClientRect();
        p.setAttribute('data-type', type); document.getElementById('filter-title').innerText = '상세 필터';
        document.getElementById('filter-reset-btn').onclick = () => { sidebarFilters[type] = (type === 'period' ? ['36M', '48M', '60M'] : []); window.renderUI(); renderPopupOptions(type); };
        renderPopupOptions(type); p.style.top = `${rect.top}px`; p.style.left = `100px`; p.classList.remove('hidden'); lucide.createIcons();
    };

    window.openHeaderFilter = (k, btn, e) => {
        if(e) e.stopPropagation();
        const p = document.getElementById('filter-popup'); const o = document.getElementById('filter-options'); if (!p || !o) return;
        if (!p.classList.contains('hidden') && p.getAttribute('data-key') === k) { window.closeFilterPopup(); return; }
        const rect = btn.getBoundingClientRect(); p.setAttribute('data-key', k);
        const vCars = getVisibleCars(); const counts = vCars.reduce((acc, car) => { const val = String(car[k] || '-'); acc[val] = (acc[val] || 0) + 1; return acc; }, {});
        const keys = Object.keys(counts).sort(); document.getElementById('filter-title').innerText = `${k} 필터`;
        document.getElementById('filter-reset-btn').onclick = () => { headerFilters[k] = []; window.renderUI(); window.closeFilterPopup(); };
        o.innerHTML = keys.map(val => `<label class="flex items-center gap-2 p-2 hover:bg-slate-50 cursor-pointer text-[11px] text-nowrap"><input type="checkbox" onchange="window.toggleHeaderFilter('${k}', '${val}')" ${(headerFilters[k]||[]).includes(val)?'checked':''}> <span class="flex-1">${val}</span> <span class="text-slate-300 text-[10px]">(${counts[val]})</span></label>`).join('');
        p.style.top = `${rect.bottom + 5}px`; p.style.left = `${Math.max(10, Math.min(rect.left - 50, window.innerWidth - 240))}px`; p.classList.remove('hidden'); lucide.createIcons();
    };

    function renderPopupOptions(type) {
        const o = document.getElementById('filter-options'); if(!o) return;
        const vCars = getVisibleCars(); const keyMap = {period: 'period', rental: 'rental', deposit: '보증금', mileage: '주행거리', year: '연식'}; const k = keyMap[type]; let html = '';
        if(type === 'period') ['36M', '48M', '60M'].forEach(opt => html += `<label class="flex items-center gap-2 p-2 text-[11px] text-nowrap"><input type="checkbox" onchange="window.toggleSidebarFilter('${type}', '${opt}')" ${sidebarFilters.period.includes(opt)?'checked':''}> ${opt}</label>`);
        else if(type === 'rental') ['30~50', '50~70', '70~90', '90~120'].forEach(opt => html += `<label class="flex items-center gap-2 p-2 text-[11px] text-nowrap"><input type="checkbox" onchange="window.toggleSidebarFilter('${type}', '${opt}')" ${sidebarFilters.rental.includes(opt)?'checked':''}> ${opt}만원</label>`);
        else { const counts = vCars.reduce((acc, car) => { const val = String(car[k] || '-'); acc[val] = (acc[val] || 0) + 1; return acc; }, {}); const keys = Object.keys(counts).sort(); html = keys.map(val => `<label class="flex items-center gap-2 p-2 hover:bg-slate-50 cursor-pointer text-[11px] text-nowrap"><input type="checkbox" onchange="window.toggleSidebarFilter('${type}', '${val}')" ${sidebarFilters[type].includes(val)?'checked':''}> <span class="flex-1">${val}</span> <span class="text-slate-300 text-[10px]">(${counts[val]})</span></label>`).join(''); }
        o.innerHTML = html;
    }

    // [v125] 참고 코드 방식의 인증 로직 (localStorage 기반)
    window.login = async () => {
        const idIn = document.getElementById('user-id-input');
        const pwIn = document.getElementById('user-pw');
        const idVal = idIn?.value.trim();
        const pwVal = pwIn?.value.trim();
        
        if (!idVal) return window.showMessage('아이디를 입력하세요.');
        if (pwVal !== "7777") return window.showMessage('보안코드가 일치하지 않습니다.');
        
        const account = ACCOUNT_MAP[idVal];
        if (!account) return window.showMessage('미등록 전산 아이디');
        
        const lBtn = document.getElementById('login-btn');
        if(lBtn) { lBtn.disabled = true; lBtn.innerText = "전산 인증 중..."; }
        
        try {
            // 로컬에 인증 정보 저장 (3개월 유지용)
            const expireTime = Date.now() + (90 * 24 * 60 * 60 * 1000);
            localStorage.setItem('erp_access_granted', 'true');
            localStorage.setItem('erp_access_id', idVal);
            localStorage.setItem('erp_access_expire', expireTime.toString());

            me.id = idVal; me.role = account.role; me.company = account.company; me.nameTitle = account.name;
            
            // Firebase 가능 환경일 때만 실제 인증 수행
            if (firebaseConfig.apiKey !== "DEMO_MODE") {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
            }
            
            document.getElementById('gate').classList.add('hidden'); 
            const appEl = document.getElementById('app');
            appEl.classList.remove('hidden');
            setTimeout(() => appEl.classList.remove('opacity-0'), 50);

            document.getElementById('name-tag').innerText = `${me.nameTitle}(${me.company})`; 
            document.getElementById('id-tag').innerText = me.id;
            
            window.initRealtimeList(); window.initSampleData(); window.renderUI();
        } catch (e) { window.showMessage('접속 실패'); if(lBtn) lBtn.disabled = false; }
    };

    window.initRealtimeList = () => { 
        if (firebaseConfig.apiKey === "DEMO_MODE") return;
        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'cars'), (snap) => { 
            rawCars = snap.docs.filter(d => !d.id.includes('SEED_DONE')).map(d => ({ id: d.id, ...d.data() })); 
            window.renderUI(); 
        }); 
    };

    window.initSampleData = async () => {
        if (firebaseConfig.apiKey === "DEMO_MODE" || rawCars.length < 5) {
            const b = ["현대", "기아", "제네시스", "BMW", "벤츠"];
            const m = { "현대": ["그랜저", "팰리세이드", "쏘나타"], "기아": ["K8", "EV6", "쏘렌토"], "제네시스": ["G80", "GV70"], "BMW": ["5시리즈", "X5"], "벤츠": ["E클래스", "GLC"] };
            rawCars = Array.from({length: 25}, (_, i) => {
                const brand = b[i % 5]; const rentalPrice = (40 + (i * 3)) * 10000;
                return { id: `${12 + i}가${1000+i}`, 구분: '신차급', 제조사: brand, 모델: m[brand][i % m[brand].length], 세부모델: '프리미엄', 주행거리: 5000 + (i * 1000), 연식: 2021 + (i % 5), 외부색상: i % 2 === 0 ? '블랙' : '화이트', 내부색상: '그레이', 금액_대여료_36M: rentalPrice.toLocaleString(), 금액_보증금_36M: (rentalPrice * 2).toLocaleString(), 공급사: i % 2 === 0 ? '3333' : '4444', 상태: '대여가능', inquiryList: {} };
            });
            window.renderUI();
        }
    };

    window.toggleHeaderFilter = (k, v) => { const arr = headerFilters[k] || []; if (arr.includes(v)) headerFilters[k] = arr.filter(x => x !== v); else headerFilters[k] = [...arr, v]; window.renderUI(); };
    window.toggleSidebarFilter = (t, v) => { const arr = sidebarFilters[t] || []; if (arr.includes(v)) sidebarFilters[t] = arr.filter(x => x !== v); else sidebarFilters[t] = [...arr, v]; window.renderUI(); };
    window.applyFilters = () => { window.renderUI(); window.closeFilterPopup(); };
    window.closeDrawer = () => { selectedId = null; const dr = document.getElementById('detail-drawer'); if(dr) dr.classList.add('translate-x-full'); window.toggleDrawerChat(false); window.renderUI(); window.toggleMainScroll(true); };
    window.toggleDrawerChat = (v) => { const dr = document.getElementById('detail-drawer'); const ct = document.getElementById('drawer-chat-area'); if (!dr || !ct) return; if (v) { dr.style.width = '840px'; ct.style.width = '380px'; } else { dr.style.width = '460px'; ct.style.width = '0px'; } lucide.createIcons(); };
    window.startInquiryFromDrawer = (id) => { selectedId = id; const c = rawCars.find(x => x.id === id); if(!c) return; if (me.role === 'sales') { currentInquiryPhone = me.id; } else { if (!currentInquiryPhone) { const inqs = Object.keys(c.inquiryList || {}); if (inqs.length > 0) currentInquiryPhone = inqs[0]; else return window.showMessage('상담 내역이 없습니다.'); } } window.toggleDrawerChat(true); loadChats(id); };
    window.openChatFromMaster = (cid, p) => { currentInquiryPhone = p; window.selectCar(cid, true); };
    function loadChats(carId) { 
        if ((!auth.currentUser && firebaseConfig.apiKey !== "DEMO_MODE") || !carId || !currentInquiryPhone) return; 
        if(chatUnsubscribe) chatUnsubscribe(); 
        if(firebaseConfig.apiKey === "DEMO_MODE") return;
        chatUnsubscribe = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'cars', carId, "chats"), (snap) => { 
            const box = document.getElementById('drawer-chat-messages'); if(!box) return; box.innerHTML = ''; const msgs = []; snap.forEach(d => { if(d.data().salespersonId === currentInquiryPhone) msgs.push({id: d.id, ...d.data()}); }); msgs.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0)); 
            msgs.forEach(m => { 
                const isM = m.senderId === me.id; if (!isM && !m.read) updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'cars', carId, 'chats', m.id), { read: true });
                const timeStr = m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '-';
                const wrapper = document.createElement('div'); wrapper.className = `chat-bubble-wrapper ${isM ? 'items-end ml-auto' : 'items-start mr-auto'}`;
                wrapper.innerHTML = `<div class="chat-bubble ${isM ? 'bubble-me' : 'bubble-other'} text-[11px] shadow-sm"><div class="text-[8px] opacity-60 mb-1 font-bold">${isM ? '나' : maskId(m.senderId)}</div><div>${m.text}</div></div>`;
                box.appendChild(wrapper); 
            }); 
            box.scrollTo({ top: box.scrollHeight, behavior: 'instant' });
        }); 
    }
    window.sendMsgFromDrawer = async () => { 
        const input = document.getElementById('drawer-chat-input'); if(!input?.value.trim()) return; const text = input.value.trim(); 
        if(firebaseConfig.apiKey === "DEMO_MODE") { window.showMessage("데모 모드 전용 (전송불가)"); input.value = ''; return; }
        try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'cars', selectedId, "chats"), { text, senderId: me.id, salespersonId: (me.role === 'sales' ? me.id : currentInquiryPhone), timestamp: serverTimestamp(), read: false }); input.value = ''; } catch (e) { window.showMessage('전송 실패'); } 
    };

    // [v125] 페이지 로드 시 자동 로그인 로직
    window.onload = () => {
        const isGranted = localStorage.getItem('erp_access_granted');
        const savedId = localStorage.getItem('erp_access_id');
        const expireTime = localStorage.getItem('erp_access_expire');
        const now = Date.now();

        if (isGranted === 'true' && savedId && expireTime && now < parseInt(expireTime)) {
            document.getElementById('user-id-input').value = savedId;
            window.login(); // 자동 로그인 실행
        } else {
            localStorage.removeItem('erp_access_granted');
            document.getElementById('gate').classList.remove('hidden');
        }
        lucide.createIcons();
    };

    onAuthStateChanged(auth, async (user) => { if (!user && firebaseConfig.apiKey !== "DEMO_MODE") signInAnonymously(auth); });
</script>
</body>
</html>
